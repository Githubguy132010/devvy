name: Branch Protection

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Install dependencies
      run: bun install --frozen-lockfile
      
    - name: Check for conventional commits
      run: |
        # Get commit messages from the PR
        commits=$(git log --format=%s origin/main..HEAD)
        echo "Commits in this PR:"
        echo "$commits"
        
        # Check if commits follow conventional commit format
        while IFS= read -r commit; do
          if [[ -n "$commit" ]]; then
            if ! echo "$commit" | grep -E "^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+" > /dev/null; then
              echo "❌ Commit does not follow conventional commit format: $commit"
              echo "Expected format: type(scope): description"
              echo "Types: feat, fix, docs, style, refactor, test, chore"
              exit 1
            else
              echo "✅ Commit follows format: $commit"
            fi
          fi
        done <<< "$commits"
        
    - name: Check package.json changes
      run: |
        if git diff --name-only origin/main..HEAD | grep -q "package.json"; then
          echo "package.json has been modified"
          if git diff --name-only origin/main..HEAD | grep -q "bun.lock"; then
            echo "✅ bun.lock also updated"
          else
            echo "❌ bun.lock should be updated when package.json changes"
            exit 1
          fi
        fi
        
    - name: Ensure no secrets
      run: |
        # Check for common secret patterns
        if grep -r -i "api_key\|secret\|password\|token" --include="*.ts" --include="*.js" src/ | grep -v "//.*secret\|//.*api_key\|//.*password\|//.*token" > /dev/null; then
          echo "❌ Potential secrets found in source code"
          grep -r -i "api_key\|secret\|password\|token" --include="*.ts" --include="*.js" src/ | grep -v "//.*secret\|//.*api_key\|//.*password\|//.*token"
          exit 1
        else
          echo "✅ No obvious secrets found"
        fi
